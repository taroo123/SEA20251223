<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>互動式人力趨勢模擬器 (2025-2034)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f8fafc; overflow-x: hidden; }
        .tab-btn { padding: 0.5rem 1rem; font-weight: 500; color: #4B5563; border-top-left-radius: .5rem; border-top-right-radius: .5rem; transition: color .2s, background-color .2s; background: transparent; border: none; cursor: pointer; }
        .tab-btn.active { background: #fff; color: #2563EB; border-bottom: 2px solid #2563EB; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .table-container { max-height: 500px; overflow-y: auto; }
        thead th { position: sticky; top: 0; background-color: #F3F4F6; z-index: 10; }
        thead th:first-child { position: sticky; left: 0; z-index: 20; background-color: #F3F4F6; }
        tbody th { position: sticky; left: 0; background: #fff; z-index: 10; }
        .scenario-btn { display: block; width: 100%; text-align: center; padding: 0.6rem 0.75rem; border-radius: 0.65rem; border: 1px solid #d1d5db; background: #f9fafb; color: #374151; font-weight: 600; cursor: pointer; transition: all .12s ease; font-size: 0.9rem; }
        .scenario-btn:hover { background: #f3f4f6; }
        .scenario-btn.active { background: #2563eb; color: white; border-color: #2563eb; }
        .cell-tooltip { position: fixed; pointer-events: none; z-index: 9999; background: rgba(20, 20, 20, 0.92); color: #fff; padding: 10px 12px; border-radius: 8px; font-size: 13px; line-height: 1.3; box-shadow: 0 6px 18px rgba(0,0,0,0.25); max-width: 360px; }
        .legend-swatch { display:inline-block; width:12px; height:12px; margin-right:6px; vertical-align:middle; border-radius:2px; }
        .year-param-table { width: 100%; border-collapse: collapse; }
        .year-param-table th, .year-param-table td { padding: 6px 4px; text-align: center; font-size: 0.875rem; border: 1px solid #e5e7eb; }
        .year-param-table input { width: 100%; padding: 4px; text-align: center; border: 1px solid #d1d5db; border-radius: 4px; }
        .writing-vertical { writing-mode: vertical-rl; text-orientation: upright; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="flex flex-row min-h-screen">
        
        <div id="sidebar-wrapper" class="relative z-30 flex-shrink-0 w-3 transition-all duration-300 ease-in-out bg-white border-r border-gray-200 shadow-2xl h-screen sticky top-0 overflow-hidden cursor-pointer">
            <div id="sidebar-label" class="absolute left-0 top-0 w-3 h-full flex flex-col items-center pt-24 bg-blue-50 transition-opacity duration-300 pointer-events-none">
                <div class="writing-vertical text-blue-700 font-bold text-sm tracking-widest opacity-80">➤ 參數控制</div>
            </div>

            <div class="w-[420px] h-full overflow-hidden">
                <div id="controls-container" class="w-full h-full overflow-y-auto p-6 bg-white opacity-0 pointer-events-none transition-opacity duration-300">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">參數控制面板</h2>

                    <div class="mb-6 flex gap-2">
                        <button onclick="window.print()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded text-sm w-full">列印報表</button>
                    </div>

                    <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                        <label class="block text-sm font-bold text-blue-800 mb-3">快選情境設定</label>
                        <div class="flex flex-col gap-2">
                            <button id="load-baseline" class="scenario-btn active" data-scenario="baseline_one_year_attrition">近一年 (Baseline)</button>
                            <button id="load-baseline-3y" class="scenario-btn" data-scenario="baseline_three_year_attrition">近三年趨勢</button>
                            <button id="load-baseline-5y" class="scenario-btn" data-scenario="baseline_five_year_attrition">近五年趨勢</button>
                            <button id="load-target-scenario" class="scenario-btn" data-scenario="target_scenario">目標優化情境</button>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">船隊與招募設定</h3>
                        <div id="fleet-forecast-inputs" class="grid grid-cols-2 gap-2 mb-4"></div>
                        <div class="max-height-[200px] overflow-auto border rounded-lg p-2 bg-gray-50">
                            <table class="year-param-table">
                                <thead><tr><th>年份</th><th>甲板實習</th><th>機艙實習</th></tr></thead>
                                <tbody id="recruitment-year-rows"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">職級詳細參數修改</h3>
                        <div id="rank-params-selector" class="space-y-4">
                            <div id="deck-rank-buttons" class="grid grid-cols-3 gap-2"></div>
                            <div id="engine-rank-buttons" class="grid grid-cols-3 gap-2"></div>
                        </div>
                        <div id="rank-detail-panel" class="mt-4 p-4 border rounded-xl bg-white shadow-inner"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex-1 min-w-0 p-4 lg:p-8">
            <div class="max-w-full mx-auto">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">互動式人力趨勢模擬器 (2025-2034)</h1>

                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-4" id="tab-nav">
                        <button class="tab-btn active" data-tab="supply-total">總人力儀表板 (供給)</button>
                        <button class="tab-btn" data-tab="total">趨勢缺口分析</button>
                        <button class="tab-btn" data-tab="trends">參數與趨勢對照</button>
                    </nav>
                </div>

                <div id="tab-supply-total" class="tab-content active mt-6 space-y-8">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">預估未來 10 年總人力供給</h3>
                        <div class="flex gap-4 mb-4 text-sm">
                            <div class="flex items-center"><span class="legend-swatch bg-blue-100 border border-blue-300"></span> 岸休 &ge; 目標值</div>
                            <div class="flex items-center"><span class="legend-swatch bg-gray-50 border border-gray-200"></span> 岸休 &lt; 目標值</div>
                        </div>
                        <div class="table-container border rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead id="table-head-supply-total" class="bg-gray-50"></thead>
                                <tbody id="table-body-supply-total" class="bg-white"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">建議每年外招 (補足當年度缺口)</h3>
                        <div class="table-container border rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead id="table-head-recommendation" class="bg-gray-50"></thead>
                                <tbody id="table-body-recommendation" class="bg-white"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-4 rounded-xl shadow-sm border"><canvas id="chart-supply-total-deck"></canvas></div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border"><canvas id="chart-supply-total-engine"></canvas></div>
                    </div>
                </div>

                <div id="tab-trends" class="tab-content mt-6 bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                    <h3 class="text-xl font-semibold mb-6">離職與晉升參數對照 (歷史 vs 目標)</h3>
                    <div class="space-y-12">
                        <section>
                            <h4 class="text-lg font-bold text-blue-700 border-l-4 border-blue-700 pl-3 mb-4">甲板部離職率趨勢</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4" id="trends-deck-attrition"></div>
                        </section>
                        <section>
                            <h4 class="text-lg font-bold text-green-700 border-l-4 border-green-700 pl-3 mb-4">甲板部晉升率趨勢</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4" id="trends-deck-promotion"></div>
                        </section>
                        <section>
                            <h4 class="text-lg font-bold text-blue-700 border-l-4 border-blue-700 pl-3 mb-4">機艙部離職率趨勢</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4" id="trends-engine-attrition"></div>
                        </section>
                        <section>
                            <h4 class="text-lg font-bold text-green-700 border-l-4 border-green-700 pl-3 mb-4">機艙部晉升率趨勢</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4" id="trends-engine-promotion"></div>
                        </section>
                    </div>
                </div>

                <div id="tab-total" class="tab-content mt-6 bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">人力缺口趨勢 (供給 - 需求)</h3>
                    <div class="table-container border rounded-lg mb-8">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead id="table-head-total" class="bg-gray-50"></thead>
                            <tbody id="table-body-total" class="bg-white"></tbody>
                        </table>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="h-[300px]"><canvas id="chart-total-deck"></canvas></div>
                        <div class="h-[300px]"><canvas id="chart-total-engine"></canvas></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="cell-tooltip" class="cell-tooltip" style="display: none;"></div>

    <script>
        const YEARS = [2025,2026,2027,2028,2029,2030,2031,2032,2033,2034];
        const RANK_IDS = { DECK: ["MASTER","C_O","_2_O","_3_O","D_CADET"], ENGINE: ["C_E","_2_E","_3_E","_4_E","E_CADET"] };
        const ONBOARD_MONTHS = 6;

        // --- Core Template ---
        const BASE_CONFIG_TEMPLATE = {
            shipForecast: [92,98,104,110,116,122,128,125,123,120],
            recruitment: { deckHistory: [124, 90, 80, 70, 65, 60, 60, 60, 60, 60], engineHistory: [108, 90, 80, 70, 65, 60, 60, 60, 60, 60] },
            initialSupply: { MASTER: 142, C_O: 138, _2_O: 218, _3_O: 251, D_CADET: 164, C_E: 146, _2_E: 138, _3_E: 179, _4_E: 233, E_CADET: 177 },
            ranks: {
                MASTER:{name:"船長",dept:"deck",needsPerShip:1,reserveRate:1.5,attritionRate:Array(10).fill(0.03),promotionRate:Array(10).fill(0),promotionSource:"C_O"},
                C_O:{name:"大副",dept:"deck",needsPerShip:1,reserveRate:1.5,attritionRate:Array(10).fill(0.01),promotionRate:Array(10).fill(0.1),promotionSource:"_2_O"},
                _2_O:{name:"二副",dept:"deck",needsPerShip:1.5,reserveRate:1.5,attritionRate:Array(10).fill(0.02),promotionRate:Array(10).fill(0.12),promotionSource:"_3_O"},
                _3_O:{name:"三副",dept:"deck",needsPerShip:1.5,reserveRate:1.5,attritionRate:Array(10).fill(0.05),promotionRate:Array(10).fill(0.21),promotionSource:"D_CADET"},
                D_CADET:{name:"甲板實習生",dept:"deck",needsPerShip:0,reserveRate:1.5,attritionRate:Array(10).fill(0.05),promotionRate:Array(10).fill(0.77),promotionSource:null}, 
                C_E:{name:"輪機長",dept:"engine",needsPerShip:1,reserveRate:1.5,attritionRate:Array(10).fill(0.06),promotionRate:Array(10).fill(0),promotionSource:"_2_E"},
                _2_E:{name:"大管",dept:"engine",needsPerShip:1,reserveRate:1.5,attritionRate:Array(10).fill(0.03),promotionRate:Array(10).fill(0.08),promotionSource:"_3_E"},
                _3_E:{name:"二管",dept:"engine",needsPerShip:1.12,reserveRate:1.5,attritionRate:Array(10).fill(0.03),promotionRate:Array(10).fill(0.07),promotionSource:"_4_E"},
                _4_E:{name:"三管",dept:"engine",needsPerShip:1.27,reserveRate:1.5,attritionRate:Array(10).fill(0.07),promotionRate:Array(10).fill(0.21),promotionSource:"E_CADET"},
                E_CADET:{name:"機艙實習生",dept:"engine",needsPerShip:0,reserveRate:1.5,attritionRate:Array(10).fill(0.04),promotionRate:Array(10).fill(0.64),promotionSource:null}
            }
        };

        const DEFAULT_PARAMS = {
            baseline_one_year_attrition: JSON.parse(JSON.stringify(BASE_CONFIG_TEMPLATE)),
            baseline_three_year_attrition: JSON.parse(JSON.stringify(BASE_CONFIG_TEMPLATE)),
            baseline_five_year_attrition: JSON.parse(JSON.stringify(BASE_CONFIG_TEMPLATE)),
            target_scenario: JSON.parse(JSON.stringify(BASE_CONFIG_TEMPLATE))
        };

        // --- Apply Logic for Scenario Presets ---
        // 3 Year Preset
        const b3yA = { MASTER:0.14, C_O:0.08, _2_O:0.05, _3_O:0.15, D_CADET:0.15, C_E:0.12, _2_E:0.09, _3_E:0.1, _4_E:0.18, E_CADET:0.13 };
        const b3yP = { C_O:0.13, _2_O:0.09, _3_O:0.24, D_CADET:0.35, _2_E:0.1, _3_E:0.1, _4_E:0.21, E_CADET:0.31 };
        // 5 Year Preset
        const b5yA = { MASTER:0.07, C_O:0.05, _2_O:0.08, _3_O:0.12, D_CADET:0.1, C_E:0.07, _2_E:0.06, _3_E:0.1, _4_E:0.13, E_CADET:0.11 };
        const b5yP = { C_O:0.12, _2_O:0.11, _3_O:0.29, D_CADET:0.43, _2_E:0.11, _3_E:0.13, _4_E:0.36, E_CADET:0.25 };

        Object.keys(b3yA).forEach(r => DEFAULT_PARAMS.baseline_three_year_attrition.ranks[r].attritionRate.fill(b3yA[r]));
        Object.keys(b3yP).forEach(r => DEFAULT_PARAMS.baseline_three_year_attrition.ranks[r].promotionRate.fill(b3yP[r]));
        Object.keys(b5yA).forEach(r => DEFAULT_PARAMS.baseline_five_year_attrition.ranks[r].attritionRate.fill(b5yA[r]));
        Object.keys(b5yP).forEach(r => DEFAULT_PARAMS.baseline_five_year_attrition.ranks[r].promotionRate.fill(b5yP[r]));

        // --- Target Scenario Setup ---
        const target = DEFAULT_PARAMS.target_scenario;
        const targetInitA = { MASTER:0.03, C_O:0.03, _2_O:0.01, _3_O:0.06, D_CADET:0.06, C_E:0.05, _2_E:0.04, _3_E:0.06, _4_E:0.06, E_CADET:0.04 };
        Object.keys(targetInitA).forEach(r => target.ranks[r].attritionRate.fill(targetInitA[r]));
        // Target Overrides
        [5,6,7,8,9].forEach(i => target.ranks.MASTER.attritionRate[i] = 0.04);
        [4,5,6,7,8,9].forEach(i => target.ranks.C_O.attritionRate[i] = 0.05);
        [2,3,4,5,6,7,8,9].forEach(i => target.ranks._2_O.attritionRate[i] = 0.03);
        // Target Promotion Overrides
        const targetInitP = { C_O:0.05, _2_O:0.10, _3_O:0.16, D_CADET:0.50, _2_E:0.09, _3_E:0.12, _4_E:0.20, E_CADET:0.45 };
        Object.keys(targetInitP).forEach(r => target.ranks[r].promotionRate.fill(targetInitP[r]));
        [3,4,5].forEach(i => target.ranks.C_O.promotionRate[i] = 0.08);
        [6,7,8,9].forEach(i => target.ranks.C_O.promotionRate[i] = 0.07);
        target.ranks._2_O.promotionRate[0] = 0.05;
        [5,6,7,8,9].forEach(i => target.ranks._3_O.promotionRate[i] = 0.15);

        let currentConfig = JSON.parse(JSON.stringify(DEFAULT_PARAMS.baseline_one_year_attrition));
        let lastResults = null;
        let currentSelectedRank = 'MASTER';

        // --- Sidebar Logic ---
        const sidebar = document.getElementById('sidebar-wrapper');
        const sidebarContent = document.getElementById('controls-container');
        sidebar.addEventListener('click', () => {
            sidebar.classList.replace('w-3', 'w-[420px]');
            sidebar.classList.remove('cursor-pointer');
            document.getElementById('sidebar-label').classList.add('opacity-0');
            sidebarContent.classList.remove('opacity-0', 'pointer-events-none');
        });
        sidebar.addEventListener('mouseleave', () => {
            sidebar.classList.replace('w-[420px]', 'w-3');
            sidebar.classList.add('cursor-pointer');
            document.getElementById('sidebar-label').classList.remove('opacity-0');
            sidebarContent.classList.add('opacity-0', 'pointer-events-none');
        });

        // --- Calculation ---
        function runSimulation() {
            const results = { years: YEARS, data: {}, recruitmentResults: {} };
            
            // 1. Calculate Demand
            const shipForecast = currentConfig.shipForecast;
            Object.keys(currentConfig.ranks).forEach(rid => {
                results.data[rid] = { demand: shipForecast.map(s => Math.round(s * currentConfig.ranks[rid].needsPerShip)), supply: [], gap: [] };
            });

            // 2. Initial Supply
            Object.keys(currentConfig.ranks).forEach(rid => {
                results.data[rid].supply[0] = currentConfig.initialSupply[rid];
            });

            // 3. Yearly Iteration
            for (let i = 1; i < YEARS.length; i++) {
                Object.keys(currentConfig.ranks).forEach(rid => {
                    const r = currentConfig.ranks[rid];
                    const prevSupply = results.data[rid].supply[i-1];
                    const attrition = prevSupply * (r.attritionRate[i] || 0);
                    const promOut = prevSupply * (r.promotionRate[i] || 0);
                    
                    let promIn = 0;
                    if (r.promotionSource && results.data[r.promotionSource]) {
                        promIn = results.data[r.promotionSource].supply[i-1] * currentConfig.ranks[r.promotionSource].promotionRate[i];
                    }

                    let external = 0;
                    if (rid === 'D_CADET') external = currentConfig.recruitment.deckHistory[i];
                    if (rid === 'E_CADET') external = currentConfig.recruitment.engineHistory[i];

                    results.data[rid].supply[i] = Math.max(0, Math.round(prevSupply - attrition - promOut + promIn + external));
                });
            }

            // 4. Calculate Gap
            Object.keys(results.data).forEach(rid => {
                results.data[rid].gap = results.data[rid].supply.map((s, i) => s - results.data[rid].demand[i]);
            });

            // 5. Dynamic Recommended Recruitment
            ["MASTER","C_O","_2_O","_3_O","C_E","_2_E","_3_E","_4_E"].forEach(rid => {
                results.recruitmentResults[rid] = calculateRecruitNeed(rid, results);
            });

            lastResults = results;
            updateUI();
        }

        function calculateRecruitNeed(rid, baseResults) {
            const needs = [];
            const rConf = currentConfig.ranks[rid];
            let tempSupply = [...baseResults.data[rid].supply];
            
            for (let i = 0; i < YEARS.length; i++) {
                const demand = baseResults.data[rid].demand[i];
                const targetSupply = demand * rConf.reserveRate;
                const diff = targetSupply - tempSupply[i];
                const need = Math.max(0, Math.round(diff));
                needs.push(need);
                // Simple propagation to future years in this temp calc
                for(let j=i+1; j<YEARS.length; j++) tempSupply[j] += need;
            }
            return needs;
        }

        function updateUI() {
            renderSupplyTable();
            renderRecTable();
            renderGapTable();
            renderTrends();
            updateCharts();
        }

        function renderSupplyTable() {
            const head = document.getElementById('table-head-supply-total');
            const body = document.getElementById('table-body-supply-total');
            
            let hHtml = `<tr><th class="px-4 py-2">職級名稱</th>`;
            YEARS.forEach(y => hHtml += `<th class="px-4 py-2">${y}</th>`);
            hHtml += `</tr>`;
            head.innerHTML = hHtml;

            let bHtml = "";
            [...RANK_IDS.DECK, ...RANK_IDS.ENGINE].forEach(rid => {
                const r = currentConfig.ranks[rid];
                bHtml += `<tr><th class="px-4 py-2 text-left bg-gray-50">${r.name}</th>`;
                lastResults.data[rid].supply.forEach((s, i) => {
                    const shore = estimateShore(rid, s, lastResults.data[rid].demand[i]);
                    const bgColor = (shore >= r.reserveRate * 6 - 6) ? 'bg-blue-100' : 'bg-gray-50';
                    bHtml += `<td class="px-4 py-2 text-center ${bgColor} font-medium">${s} <span class="text-[10px] block text-gray-500">${shore}m</span></td>`;
                });
                bHtml += `</tr>`;
            });
            body.innerHTML = bHtml;
        }

        function estimateShore(rid, supply, demand) {
            if (demand <= 0) return 0;
            const r = currentConfig.ranks[rid];
            const ratio = supply / demand;
            let val = 6 * (r.reserveRate - 1) * (ratio / r.reserveRate);
            return Math.max(0, Math.round(val * 10) / 10);
        }

        function renderRecTable() {
            const body = document.getElementById('table-body-recommendation');
            const head = document.getElementById('table-head-recommendation');
            
            let hHtml = `<tr><th class="px-4 py-2">職級</th>`;
            YEARS.forEach(y => hHtml += `<th class="px-4 py-2">${y}</th>`);
            head.innerHTML = hHtml + "</tr>";

            let bHtml = "";
            Object.keys(lastResults.recruitmentResults).forEach(rid => {
                bHtml += `<tr><th class="px-4 py-2 text-left">${currentConfig.ranks[rid].name}</th>`;
                lastResults.recruitmentResults[rid].forEach(v => {
                    bHtml += `<td class="px-4 py-2 text-center ${v > 0 ? 'text-red-600 font-bold bg-red-50' : 'text-gray-400'}">${v || '-'}</td>`;
                });
                bHtml += `</tr>`;
            });
            body.innerHTML = bHtml;
        }

        function renderGapTable() {
            const body = document.getElementById('table-body-total');
            const head = document.getElementById('table-head-total');
            let hHtml = `<tr><th class="px-4 py-2">職級</th>`;
            YEARS.forEach(y => hHtml += `<th class="px-4 py-2">${y}</th>`);
            head.innerHTML = hHtml + "</tr>";

            let bHtml = "";
            [...RANK_IDS.DECK, ...RANK_IDS.ENGINE].forEach(rid => {
                bHtml += `<tr><th class="px-4 py-2 text-left">${currentConfig.ranks[rid].name}</th>`;
                lastResults.data[rid].gap.forEach(g => {
                    const color = g < 0 ? 'text-red-600 bg-red-50' : 'text-blue-700 bg-blue-50';
                    bHtml += `<td class="px-4 py-2 text-center font-bold ${color}">${g > 0 ? '+' + g : g}</td>`;
                });
                bHtml += `</tr>`;
            });
            body.innerHTML = bHtml;
        }

        function renderTrends() {
            const types = [
                { id: 'trends-deck-attrition', dept: 'DECK', key: 'attritionRate', label: '離職率' },
                { id: 'trends-deck-promotion', dept: 'DECK', key: 'promotionRate', label: '晉升率' },
                { id: 'trends-engine-attrition', dept: 'ENGINE', key: 'attritionRate', label: '離職率' },
                { id: 'trends-engine-promotion', dept: 'ENGINE', key: 'promotionRate', label: '晉升率' }
            ];

            types.forEach(t => {
                const container = document.getElementById(t.id);
                container.innerHTML = "";
                RANK_IDS[t.dept].forEach(rid => {
                    if (t.key === 'promotionRate' && !currentConfig.ranks[rid].promotionSource && rid !== 'D_CADET' && rid !== 'E_CADET') return;
                    
                    const card = document.createElement('div');
                    card.className = "bg-gray-50 p-3 rounded-lg border";
                    card.innerHTML = `<h5 class="text-sm font-bold mb-2">${currentConfig.ranks[rid].name}</h5><div class="h-32"><canvas id="canvas-${t.id}-${rid}"></canvas></div>`;
                    container.appendChild(card);

                    const history = [
                        (DEFAULT_PARAMS.baseline_five_year_attrition.ranks[rid][t.key][0] * 100).toFixed(1),
                        (DEFAULT_PARAMS.baseline_three_year_attrition.ranks[rid][t.key][0] * 100).toFixed(1),
                        (DEFAULT_PARAMS.baseline_one_year_attrition.ranks[rid][t.key][0] * 100).toFixed(1)
                    ];
                    const targetData = currentConfig.ranks[rid][t.key].map(v => (v * 100).toFixed(1));
                    const avg = (history.reduce((a,b) => parseFloat(a)+parseFloat(b), 0) / 3).toFixed(1);

                    new Chart(document.getElementById(`canvas-${t.id}-${rid}`), {
                        type: 'line',
                        data: {
                            labels: ['近5y','近3y','近1y', ...YEARS],
                            datasets: [
                                { label: '歷史', data: [...history, null, null, null, null, null, null, null, null, null, null], borderColor: '#3b82f6', backgroundColor: '#3b82f6', pointRadius: 4 },
                                { label: '目標', data: [null, null, null, ...targetData], borderColor: '#ef4444', borderDash: [5,5], pointRadius: 2 },
                                { label: '平均', data: Array(13).fill(avg), borderColor: '#94a3b8', borderDash: [2,2], pointRadius: 0, fill: false }
                            ]
                        },
                        options: { 
                            responsive: true, maintainAspectRatio: false, 
                            plugins: { legend: { display: false }, datalabels: { display: false } },
                            scales: { y: { beginAtZero: true, ticks: { font: { size: 9 } } }, x: { ticks: { font: { size: 9 } } } }
                        }
                    });
                });
            });
        }

        // --- Init Sidebar UI ---
        function initSidebar() {
            // Fleet
            const fleetDiv = document.getElementById('fleet-forecast-inputs');
            currentConfig.shipForecast.forEach((val, i) => {
                fleetDiv.innerHTML += `<div><label class="text-[10px] text-gray-500">${YEARS[i]}</label><input type="number" value="${val}" onchange="updateShipForecast(${i}, this.value)" class="w-full border rounded p-1 text-sm"></div>`;
            });

            // Recruitment
            const recRows = document.getElementById('recruitment-year-rows');
            YEARS.forEach((y, i) => {
                recRows.innerHTML += `<tr><td>${y}</td>
                    <td><input type="number" value="${currentConfig.recruitment.deckHistory[i]}" onchange="updateRec('deck', ${i}, this.value)"></td>
                    <td><input type="number" value="${currentConfig.recruitment.engineHistory[i]}" onchange="updateRec('engine', ${i}, this.value)"></td>
                </tr>`;
            });

            // Rank Selection
            const dBtn = document.getElementById('deck-rank-buttons');
            const eBtn = document.getElementById('engine-rank-buttons');
            [...RANK_IDS.DECK].forEach(rid => dBtn.innerHTML += `<button onclick="selectRank('${rid}')" class="rank-btn text-xs border rounded p-1 ${currentSelectedRank===rid?'bg-blue-600 text-white':''}" id="btn-${rid}">${currentConfig.ranks[rid].name}</button>`);
            [...RANK_IDS.ENGINE].forEach(rid => eBtn.innerHTML += `<button onclick="selectRank('${rid}')" class="rank-btn text-xs border rounded p-1" id="btn-${rid}">${currentConfig.ranks[rid].name}</button>`);
            
            selectRank('MASTER');
        }

        function selectRank(rid) {
            currentSelectedRank = rid;
            document.querySelectorAll('.rank-btn').forEach(b => b.classList.remove('bg-blue-600', 'text-white'));
            document.getElementById(`btn-${rid}`).classList.add('bg-blue-600', 'text-white');
            
            const r = currentConfig.ranks[rid];
            const panel = document.getElementById('rank-detail-panel');
            panel.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold">需求/船</label><input type="number" step="0.01" value="${r.needsPerShip}" onchange="updateRankParam('${rid}', 'needsPerShip', this.value)" class="w-full border p-1 rounded text-sm"></div>
                    <div><label class="block text-xs font-bold">設定儲備率</label><input type="number" step="0.1" value="${r.reserveRate}" onchange="updateRankParam('${rid}', 'reserveRate', this.value)" class="w-full border p-1 rounded text-sm"></div>
                </div>
                <div class="mt-4"><h5 class="text-xs font-bold mb-2">離職率設定 (各年)</h5>
                    <div class="grid grid-cols-5 gap-1">${r.attritionRate.map((v, i) => `<input type="number" step="0.01" value="${v}" onchange="updateRankArray('${rid}', 'attritionRate', ${i}, this.value)" class="border p-1 text-[10px] rounded">`).join('')}</div>
                </div>
            `;
        }

        // --- Update Functions ---
        window.updateShipForecast = (idx, val) => { currentConfig.shipForecast[idx] = parseFloat(val); runSimulation(); };
        window.updateRec = (dept, idx, val) => { currentConfig.recruitment[dept+'History'][idx] = parseInt(val); runSimulation(); };
        window.updateRankParam = (rid, key, val) => { currentConfig.ranks[rid][key] = parseFloat(val); runSimulation(); };
        window.updateRankArray = (rid, key, idx, val) => { currentConfig.ranks[rid][key][idx] = parseFloat(val); runSimulation(); };

        // --- Scenario Loading ---
        document.querySelectorAll('.scenario-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.scenario-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentConfig = JSON.parse(JSON.stringify(DEFAULT_PARAMS[btn.dataset.scenario]));
                runSimulation();
                selectRank(currentSelectedRank);
            });
        });

        // --- Tabs ---
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(`tab-${btn.dataset.tab}`).classList.add('active');
            });
        });

        // --- Charts Update ---
        function updateCharts() {
            renderGapChart('chart-total-deck', RANK_IDS.DECK, '甲板部缺口');
            renderGapChart('chart-total-engine', RANK_IDS.ENGINE, '機艙部缺口');
            renderSupplyBar('chart-supply-total-deck', RANK_IDS.DECK, '甲板部供給與岸休');
            renderSupplyBar('chart-supply-total-engine', RANK_IDS.ENGINE, '機艙部供給與岸休');
        }

        function renderGapChart(id, rids, title) {
            const ctx = document.getElementById(id).getContext('2d');
            if (window.chartInstances[id]) window.chartInstances[id].destroy();
            window.chartInstances[id] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: YEARS,
                    datasets: rids.map((rid, i) => ({
                        label: currentConfig.ranks[rid].name,
                        data: lastResults.data[rid].gap,
                        borderColor: ['#2563eb','#7c3aed','#db2777','#ea580c','#16a34a'][i],
                        tension: 0.3, fill: false
                    }))
                },
                options: { responsive: true, plugins: { title: { display: true, text: title }, datalabels: { display: false } } }
            });
        }

        function renderSupplyBar(id, rids, title) {
            const ctx = document.getElementById(id).getContext('2d');
            if (window.chartInstances[id]) window.chartInstances[id].destroy();
            window.chartInstances[id] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: YEARS,
                    datasets: rids.map((rid, i) => ({
                        label: currentConfig.ranks[rid].name,
                        data: lastResults.data[rid].supply,
                        backgroundColor: ['#93c5fd','#c4b5fd','#f9a8d4','#fdba74','#86efac'][i]
                    }))
                },
                options: { responsive: true, scales: { x: { stacked: true }, y: { stacked: true } }, plugins: { title: { display: true, text: title }, datalabels: { display: false } } }
            });
        }

        // Init
        initSidebar();
        runSimulation();
    </script>
</body>
</html>
